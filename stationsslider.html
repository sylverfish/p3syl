<!DOCTYPE html>
<html lang="en">
  <head>      
    <meta charset="utf-8">      
    <title>Stations - D3</title>

    <script type="text/javascript" src="d3/d3.js"></script>
   	<link type="text/css" rel="stylesheet" href="cal/cal-heatmap.css"/>
	<link rel="stylesheet" href="mystyle.css">
    <style type="text/css">
	    body{
			padding-top:20px;
		    font-family: "Open Sans";
		    color: gray;
		    /*background-color: #400000; 
*/		    background-color: #FFF; 		    
		}

		.cal-heatmap-container .q1
		{
			background-color: #200000;
			fill: #200000
		}

		/* unvisited link */
		a:link {
		    color: gray;
		}

		/* visited link */
		a:visited {
		    color: gray;
		}

		/* mouse over link */
		a:hover {
		    color:gray;
		}

		/* selected link */
		a:active {
		    color: gray;
		}

    </style>

    <script src="javascripts/prototype.js" type="text/javascript"></script>
	<script src="javascripts/scriptaculous.js" type="text/javascript"></script>

     <script type="text/javascript" src="cal/cal-heatmap.js"></script>

     <script>
		
     </script>

    
  </head>
  <!--onClick="changeThePage(event)" -->
<body onkeydown="checkKey(event)"  style="padding:0; margin:0" onLoad="drawTheSvg()">
	<!-- style="background-image: url(images/bg.jpg);padding:0; margin:0" -->
	<!--style="background-image: url(images/bg.jpg)"-->
	<script type="text/javascript">
	function skip(){
		var n = pages-page;
		page=pages;
		hideLogo();
		Effect.Appear('snippet', {duration: 0.8} );
		Effect.Appear('finalmenu');
		Effect.DropOut('selyears');
		l=l-speed*n;
		x=l;
		lx = lx-speed*n;
		if(x<=-pages*speed*n) {x=-pages*speed*n; l=-pages*speed*n;}
		cx=l;
		if(cx<=-pages*speed*n) {x=-pages*speed*n; l=-pages*speed*n;}
	    update();
	}

	function skipToStart(){
		
		var n = page;

		page = 1;
		Effect.Appear('snippet', {duration: 0.8} );
		Effect.Appear('selyears');
		Effect.DropOut('finalmenu');

		if(x>=0) {
	    		l=0;
	    		lx=0;
	    		cx=0;
	    		showLogo();
	    		Effect.Shake('chart',{duration:0.1, distance:5}); 
	    		return;
	    	}
    	
    	l=l+speed*n;
		x=l;
		lx = lx+speed*n;
		cx=l;
		// console.log("L:"+x);
		if(x>=0) {
    		l=0;
    		lx=0;
    		cx=0;
    		showLogo();
	    }
		update();
	}
	function changeThePage(e){
		var x = e.pageX;
		
		if(x<=clipWidth/8){
			moveLeft();
		}
		if(x>=7*clipWidth/8){
			moveRight();
		};
   	}

    function hideLogo(){
    	//document.getElementById("title").style.display = "none";
    	//document.getElementById("title").style.display = "none";
    	// Effect.Fade('id_of_element', { duration: 3.0 });
    	if(!hidden){
    		Effect.Fade('title',{ duration: 1.0, from: 1, to: 0 });
    		hidden=true;
    	}

    }

    var hidden = false;

    function showLogo(){
    	//document.getElementById("title").style.display = "block";
    	Effect.Appear('title', { duration: 1.0 });
    	// Effect.Appear('selyears')
    	// document.getElementById("selyears").style.display = "block";
    	hidden = false;
    }

    function hidePopup(){
    	Effect.Fade('popme',{ duration: 1.0, from: 1, to: 0 });
    }
    
    </script>


	<div id="title" style="position: absolute; top:10px; left:20px; display:block">
		<svg width="300" height="300">
			<circle cx="150" cy="80" r="55" stroke="blue" stroke-width="27" fill="white"/>
  			 <rect width="160" height="40" x="70" y="60" style="fill:rgb(255,0,0)" />
  			 <text x="103" y="85" fill="white" >Destinations</text>
  			 <text x="32" y="170" fill="grey" style="font-family: Georgia; font-size: x-small">
  								  A visual representation of the tragic situation of 
		    <tspan x="20" y="190">accidents on the Mumbai Suburban Railway Network.</tspan>
		    <tspan x="31" y="210">(Thane to CST Mumbai, Andheri to Churchgate)</tspan>		    
		</svg>	
		<br/>
		<span style="font-size: x-small; color: grey" >(Press arrow keys LEFT and RIGHT) Or click on the left or right of the page</style>
	</div>
	<div id="chart"  ></div>
	<!--<div><span id="left">Left</span> | <span id="right">Right</span></div>-->




	<script>
var gender=[50,150];
	var clipWidth = 1200;
	var clipHeight = 800;
	width = 100;
	var x=0;
	var cx=0;
	var lx=0;

	

	var prev=0;	
	var cprev=0;	

	var pad=20;	
	var l=0;
	var speed=1100;
	var pages=6;
	var update;
	var updatePie;
	var datasource = "data/2014Trains.csv";
	var svg=null;

	var something=false;
	function drawTheSvg(){

		if(svg!=null){
			console.log("removed svg to add new one")
			svg.remove()
		}
		
		d3.csv([datasource], function(error, data){
			svg= d3.select('#chart').append('svg')
		    .attr('width', clipWidth)
		    .attr('height', clipHeight);

		    svg.append("defs").append("clipPath")
		    .attr("id", "clip")
		    .append("rect")
		        .attr("width", clipWidth)
		        .attr("height", clipHeight);

		    var g = svg.append("g");

			

			var lines = g.selectAll("line")
			.data(data).enter();

			lines
		    .insert('line') //left
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "l1")
		    	.attr("x1", function(d){return lx+parseInt(d.inx1)})
		    	.attr("y1", function(d){return parseInt(d.iny1)})
		    	.attr("x2", function(d){return lx+parseInt(d.inx2)})
		    	.attr("y2", function(d){return parseInt(d.iny2)})
		    	.attr("stroke",function(d){if(d.Line=="CR") return "lightblue"; else return "pink";})
		    	.attr("fill", "none")
		    	.attr("stroke-width", "6")
		    	.attr("stroke-opacity","0.7")
		    	// .style("stroke-dasharray", ("2,4,2,4,2,4"));
		    	// .attr("style", "stroke:rgb(255,0,0);stroke-width:2");
		        // .style("stroke-dasharray", ("3, 3"));  //function(d){return d.Deaths}
		    ;

		   //  svg
		   //  .on("click", function(d){
		   //  	console.log(";;;;;;;;;;;;;;;;;;;;")
		   //  	var coordinates = [0, 0];
					// coordinates = d3.mouse(this);
					// var x = coordinates[0];
					// var snippet = document.getElementById('snippet')
					// 	snippet.innerHTML = snippet.innerHTML+" "+x;
					// if(x<=clipWidth/2){
						
					// 	moveLeft();
					// }else{
					// 	moveRight()
					// };
		   //  });

			var popped = false;

			var rects = g.selectAll("rect")
			.data(data).enter();
			
			rects
		    .insert('rect') //rect
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "stationsrect")
		    	.attr("width",100)
		    	.attr("height", 20)
		    	.attr("rx", 6)
    			.attr("ry", 6)
		    	.attr("x", function(d){ return lx+parseInt(d.rX)-10})
				.attr("y", function(d){return parseInt(d.rY)})
				.attr("fill", function(d){
					if(d.Type=="Interchange") return "#8AB66D";
					if(d.Type=="Slow") return "#99A6B0";
					if(d.Type=="Fast") return "#BC5C3D";
				})
				// .style("fill-opacity", "0.8")
				.on("click", function(d){
					if(!popped){
						var popme = document.getElementById('popme');               	
	                	var st = document.getElementById('stationName');
	                	st.innerHTML = d.Station;
	                	dataV = "jsons/"+d.Station+"All.json"

						showCalendar();
						Effect.Appear('popme', {duration: 1.0} );
						popped = true;
					}
					else{
						Effect.Fade('popme');
						popped = false;						
					}
					// return false;
				})
				.on("mouseover", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");
                	d3.select(this)
                	.append("title")
                	.text(d.Type + " Station");
          			// 
    	
                	// document.getElementById('popme').style.display = "block";
                	showCalendar();
                })
                .on("mouseout", function(d){
                	d3.select(this)
                	// .style("fill-opacity", "0.8");

                	// document.getElementById('popme').style.display = "none";

                })
		    ;

		    lines
		    .insert('line') //right
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "l2")
		    	.attr("x1", function(d){return lx+parseInt(d.outx1)})
		    	.attr("y1", function(d){return parseInt(d.outy1)})
		    	.attr("x2", function(d){return lx+parseInt(d.outx2)})
		    	.attr("y2", function(d){return parseInt(d.outy2)})
		    	.attr("stroke",function(d){
		    		return "lightgrey";
		    		// if(d.Line=="CR") return "lightblue"; else return "pink";
		    	})
		    	.attr("fill", "none")
		    	.attr("stroke-width", "6")
		    	.attr("stroke-opacity","0.7")
		    	// .style("stroke-dasharray", ("2,4,2,4,2,4"));
		    	;
		    	// .attr("style", "stroke:rgb(255,0,0);stroke-width:2");
		        // .style("stroke-dasharray", ("3, 3"));  //function(d){return d.Deaths}
		    ;

		    
		    var circles = g.selectAll("circle")
			.data(data).enter();

			circles
			.insert('circle')
				.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "cAll")
		    	.attr("cx", function(d){
		    		return lx+parseInt(d.rX)+40;
		    	})
		    	.attr("cy", function(d){
		    		if(d.Line == "CR")
		    			return parseInt(d.rY)-parseInt(d.All)/2-40-10;
		    		else
		    			return parseInt(d.rY)+parseInt(d.All)/2+40+20;
		    	})
		    	.attr("r", function(d){if(parseInt(d.All)==0) return 1; return parseInt(d.All)/2})
		    	.attr("fill", "#FFCC00")
		    	.attr("fill-opacity","0.6")
		    	.on("mouseover", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");

                	d3.select(this)
                	.append("title")
                	.text(d.All + " incidents, and "+d.Deaths +" deaths at "+d.Station);
				})
		    	.on("click", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");

                	d3.select(this)
                	.append("title")
                	.text(d.All + " incidents, and "+d.Deaths +" deaths at "+d.Station);

                	var coordinates = [0, 0];
					coordinates = d3.mouse(this);
					var x = coordinates[0];
					var y = coordinates[1];
					
                	
                	
                	if(!popped){
                		var popme = document.getElementById('popme');               	
	                	var st = document.getElementById('stationName');
	                	st.innerHTML = d.Station;
	                	dataV = "jsons/"+d.Station+"All.json"
                		showCalendar();
						Effect.Appear('popme', {duration: 1.0} );
						popped = true;
					}
					else{
						Effect.Fade('popme');
						popped = false;
					}

                	// popme.style.display = "block";
                	// console.log(x + " " + y)
                	// popme.style = "position: absolute; top:"+(y+150)+"px; left:"+(x+30)+"px; border:1px solid red; color: red; padding:5px; display: none" ;
                	
                	// Effect.Appear('popme', {duration: 1.0} );

                	// popme.style=('position', 'absolute' );

                	//http://stackoverflow.com/questions/16770763/mouse-position-in-d3
                	//http://stackoverflow.com/questions/14825864/jquery-show-a-hidden-div-at-mouse-position-when-a-link-is-clicked

                	gender= [d.Male, d.Female];
                	updatePie();
     //            	console.log(gender[0], gender[1])
     //            	var color = d3.scale.category10();
					// var arc = d3.svg.arc()
					//     .innerRadius(200)
					//     .outerRadius(240)
					//     .cornerRadius(20);
					// var pie = d3.layout.pie()
					//     .padAngle(.02);

				 //    var pies = g.selectAll("path")
					// .data(gender).enter();

					// pies.insert("path")
					//     .style("fill", function(d, i) { return color(i); })
					//     .attr("d", arc);

		    	
                })
                .on("mouseout", function(d){
                	d3.select(this)
                	.style("fill-opacity", "0.6");

                	// document.getElementById('popme').style.display = "none";
                	// Effect.Fade('popme', {duration: 5.0, from: 1, to: 0} );

                })
		    	;	

		    
		    circles
			.insert('circle')
				.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "cDeaths")
		    	.attr("cx", function(d){return lx+parseInt(d.rX)+40})
		    	.attr("cy", function(d){if(d.Line == "CR")
		    			return parseInt(d.rY)-d.Deaths/2-40-10;
		    		else
		    			return parseInt(d.rY)+d.Deaths/2+40+20;
		    	})
		    	.attr("r", function(d){if(d.All==0) return 1; return d.Deaths/2})
		    	.attr("fill", "darkred")
		    	.attr("fill-opacity","0.8")
		    	.on("mouseover", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");
                	d3.select(this)
                	.append("title")
                	.text(d.All + " incidents, and "+d.Deaths +" deaths at "+d.Station);
                })
		    	.on("click", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");
                	d3.select(this)
                	.append("title")
                	.text(d.All + " incidents, and "+d.Deaths +" deaths at "+d.Station);
                	// document.getElementById('popme').style.display = "block";
                	if(!popped){
                		var popme = document.getElementById('popme');               	
	                	var st = document.getElementById('stationName');
	                	st.innerHTML = d.Station;
	                	dataV = "jsons/"+d.Station+"All.json"

                		showCalendar();
						Effect.Appear('popme', {duration: 1.0} );
						popped = true;
					}
					else{
						Effect.Fade('popme');
						popped = false;
					}
                	// showCalendar();
                })
                .on("mouseout", function(d){
                	d3.select(this)
                	.style("fill-opacity", "0.8");

                	// document.getElementById('popme').style.display = "none";
                })
		    	;


		   	 
			

		 //   	var arc = d3.svg.arc()
			//     .innerRadius(radius - 40)
			//     .outerRadius(radius)
			//     .cornerRadius(20);

			// var pie = d3.layout.pie()
			//     .padAngle(.02);

			// var color = d3.scale.category10();


			// var pies = g.selectAll("path")
			// .data(pie(data)).enter();

			// pies
			// .insert("path")
			// .style("fill", function(d, i) { return color(i); })
   //  		.attr("d", arc);

	   	
			rects
		    .insert('rect') //gender
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "gender1")
		    	// .attr("width", function(d){return d.Male/2})
		    	.attr("width", function(d){
		    		m=parseInt(d.Male);
		    		f=parseInt(d.Female);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// console.log("M:"+t)
		    		return t;
		    	})
		    	.attr("height", 10 )
		    	.attr("x", function(d){return lx+parseInt(d.rX);})
				.attr("y", function (d) {
                	if(d.Line=="CR")
		    			return parseInt(d.rY)-35;
		    		else
		    			return parseInt(d.rY)+35		    			
                })
				.attr("fill", "#31A2FD")
				.on("mouseover", function(d){
					var total = parseInt(d.Male) + parseInt(d.Female);
					var m = Math.round(d.Male/total*100);
					var f = Math.round(d.Female/total*100);
                	d3.select(this)
                	.append("title")
                	.text(m + "% male, and "+ f +"% female");
                })
		    ;

		    rects
		    .insert('rect') //gender
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "gender2")
		    	// .attr("width", function(d){return d.Female/2})
		    	.attr("width", function(d){
		    		m=parseInt(d.Male);
		    		f=parseInt(d.Female);
		    		if((m+f)>0){
		    			t = f/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// t2=10-t
		    		// console.log("F:"+t)
		    		return t;
		    	})


		    	.attr("height", 10 )
		    	.attr("x", function(d){
		    		m=parseInt(d.Male);
		    		f=parseInt(d.Female);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;

		    		return lx+t+parseInt(d.rX);
		    	})
				.attr("y", function(d){
					if(d.Line=="CR")
		    			return parseInt(d.rY)-35;
		    		else
		    			return parseInt(d.rY)+35
		    	})
				.attr("fill", "#491B65")
				.on("mouseover", function(d){
					var total = parseInt(d.Male) + parseInt(d.Female);
					var m = Math.round(d.Male/total*100);
					var f = Math.round(d.Female/total*100);
                	d3.select(this)
                	.append("title")
                	.text(m + "% male, and "+ f +"% female");
                })
		    ;

		  //   rects
		  //   .insert('rect') //gender
		  //   	.attr("class", "area").attr("clip-path", "url(#clip)")
		  //   	.attr("id", "gender1")
		  //   	.attr("width", 10 )//function(d){return d.Male/2}
		  //   	.attr("height", function(d){
		  //   		total=parseInt(d.Male)+parseInt(d.Female);
		  //   		if(total==0)
		  //   			h=0;
		  //   		else{
		  //   			h=d.Male/(total)*10; 
		  //   		}
		  //   		return  Math.round(h);
		  //   		})
		  //   	.attr("x", function(d){return lx+parseInt(d.rX)-15;})
				// .attr("y", function(d){return parseInt(d.rY)})
				// .attr("fill", "blue")
		  //   ;

		    // function(d){}

		  //   rects
		  //   .insert('rect') //gender
		  //   	.attr("class", "area").attr("clip-path", "url(#clip)")
		  //   	.attr("id", "gender2")
		  //   	.attr("width", 10 )//function(d){return d.Male/2}
		  //   	.attr("height", function(d){
		  //   		total=parseInt(d.Male)+parseInt(d.Female);
		  //   		if(total==0)
		  //   			h=0;
		  //   		else{
		  //   			h=d.Male/(total)*10;  
		  //   		}
		  //   		return Math.round(h);
		  //   		})
		  //   	.attr("x", function(d){return lx+parseInt(d.rX)+15;})
				// .attr("y", function(d){
				// 	t=parseInt(d.Male)+parseInt(d.Female);
		  //   		if(total==0)
		  //   			th=0;
		  //   		else{
		  //   			th=d.Male/(t)*10; 
		  //   		}
		  //   		console.log(h);
				// 	return Math.round(parseInt(d.rY)+h)})
				// .attr("fill", "green")
		  //   ;

		    rects
		    .insert('rect') //day
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "day")
		    	.attr("width", function(d){
		    		m=parseInt(d.Day);
		    		f=parseInt(d.Night);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// t2=10-t
		    		// console.log("F:"+t)
		    		return t;})
		    	.attr("height", 10 )
		    	.attr("x", function(d){return lx+parseInt(d.rX);})
				.attr("y", function(d){
					if(d.Line=="CR")
		    			return parseInt(d.rY)-20;
		    		else
		    			return parseInt(d.rY)+20;
		    	})
				.attr("fill", "#CC9900")
				.on("mouseover", function(d){
					var total = parseInt(d.Day) + parseInt(d.Night);
					var m = Math.round(d.Day/total*100);
					var f = Math.round(d.Night/total*100);
                	d3.select(this)
                	.append("title")
                	.text(m + "% during daytime, and "+ f +"% during nights");
                })
		    ;

		     rects
		    .insert('rect') //night
		    	.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "night")
		    	.attr("width", function(d){
		    		m=parseInt(d.Day);
		    		f=parseInt(d.Night);
		    		if((m+f)>0){
		    			t = f/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// t2=10-t
		    		// console.log("F:"+t)
		    		return t;})
		    	.attr("height", 10 )
		    	.attr("x", function(d){
		    		m=parseInt(d.Day);
		    		f=parseInt(d.Night);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;

		    		return lx+t+parseInt(d.rX);
		    	})
				.attr("y", function(d){
					if(d.Line=="CR")
		    			return parseInt(d.rY)-20;
		    		else
		    			return parseInt(d.rY)+20;
		    	})
				.attr("fill", "#AEAEAE")
				.on("mouseover", function(d){
					var total = parseInt(d.Male) + parseInt(d.Female);
					var m = Math.round(d.Day/total*100);
					var f = Math.round(d.Night/total*100);
                	d3.select(this)
                	.append("title")
                	.text(m + "% during daytime, and "+ f +"% during nights");
                })
		    ;


			

		    var text = g.selectAll("text")
				.data(data).enter();

			text
				.insert('text')
				.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "stations")
		    	.attr("x", function(d){return lx+parseInt(d.rX)})
		    	.attr("y", function(d){return parseInt(d.rY)+15})
		    	.text(function (d) {return d.Station;})
		    	.attr("font-family", "sans-serif")
                .attr("font-size", "11px")
                .attr("fill", "white")
                .style("fill-opacity", "0.7")
		    	;

		   	text
				.insert('text')
				.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "figures")
		    	.attr("x", function(d){return lx+parseInt(d.rX)+60})
		    	// .attr("x", function(d){return lx+parseInt(d.rX)+30+d.All/2})
		    	// .attr("y", function(d){return lx+parseInt(d.rY)-d.All/2-25})
		    	// .attr("y", function(d){return lx+parseInt(d.rY)-d.All/2-25})
		    	.attr("y", function(d){
		    		if(d.Line=="CR")
		    			return parseInt(d.rY)-75;
	    			else
		    			return parseInt(d.rY)+105;
		    	})
		    	.text(function (d) {
		    		if(d.All==0)
		    			return "No incidents"
		    		else
		    			return d.All;
		    	})
		    	.attr("font-family", "Open Sans")
		    	.attr("font-weight", function (d) {
                	if(d.All==0)
		    			return "Light"
		    		else
		    			return "Bold";
                	// var size=Math.round(d.All/2);
                	// if(size<9) size=9;
                	// return size;
                })
                .attr("font-size", function (d) {
                	if(d.All==0)
		    			return 10
		    		else
		    			return 35;
                	// var size=Math.round(d.All/2);
                	// if(size<9) size=9;
                	// return size;
                })
                .attr("fill", "grey")
                .style("fill-opacity", "0.7")
                .on("mouseover", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");

                	d3.select(this)
                	.append("title")
                	.text("Incidents in a year");
                })
                .on("mouseout", function(d){
                	d3.select(this)
                	.style("fill-opacity", "0.7");
                })
		    	;

		   	text
				.insert('text')
				.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "figuresdeaths")
		    	// .attr("x", function(d){return lx+parseInt(d.rX)+d.All/2+30})
		    	// .attr("y", function(d){return lx+parseInt(d.rY)-25})
		    	.attr("x", function(d){return lx+parseInt(d.rX)+70})
		    	.attr("y", function(d){
		    		if(d.Line=="CR")
		    			return parseInt(d.rY)-55;
	    			else
		    			return parseInt(d.rY)+75;
		    	})
		    	.text(function (d) {
		    		if(d.All==0) 
		    			return "";
		    		else 
		    			return d.Deaths;
		    	})
		    	.attr("font-family", "Open Sans")
		    	.attr("font-weight", "light")
                .attr("font-size", function (d) {
                	// var size=Math.round(d.All/3);
                	// if(size<9) size=9;
                	// return size;
                	return 16;
                })
                .attr("fill", "grey")
                .style("fill-opacity", "0.7")
                .on("mouseover", function(d){
                	d3.select(this)
                	.style("fill-opacity", "1");

                	d3.select(this)
                	.append("title")
                	.text("Deaths in a year");
                })
                .on("mouseout", function(d){
                	d3.select(this)
                	.style("fill-opacity", "0.7");
                })
		    	;


		    	//function(d){return lx+parseInt(d.rY)-d.Deaths/2-25}

		 //    circles
			// .insert('circle')
			// 	.attr("class", "area").attr("clip-path", "url(#clip)")
		 //    	.attr("id", "cDeaths")
		 //    	.attr("cx", function(d){function(d){if(d.All==0) return 1; return xScale(d.Deaths)})
		 //    	.attr("cy", 200)
		 //    	.attr("r", function(d){if(d.All==0) return 1; return xScale(d.Deaths)})
		 //    	.attr("fill", "red")
		    	;	    

		 //    g.selectAll("rect")
			// .data(data).enter()
		 //    .insert('rect') //rect
		 //    	.attr("class", "area").attr("clip-path", "url(#clip)")
		 //    ;

		 //    g.selectAll("circle")
			// .data(data).enter()
		 //    .insert('line') //circle
		 //    	.attr("class", "area").attr("clip-path", "url(#clip)")
		 //    ;

		 //    g.selectAll("line")
			// .data(data).enter()
		 //    .insert('line') //right
		 //    	.attr("class", "area").attr("clip-path", "url(#clip)")
		 //    ;

			// g.selectAll("rect")
		 //    // .data(data).enter().append('rect')
		 //    //     .attr("class", "area").attr("clip-path", "url(#clip)")
		 //    //     .attr('x', function(d){x=x+prev+pad; prev=parseInt(d.All); return x;})
		 //    //     // .attr('x', function(d){return xScale(d.x)})
		 //    //     .attr('width', function(d){if(d.All==0) return 1; return (d.All)})
		 //    //     .attr('height', function(d){if(d.All==0) return 1; return (d.All)} )
		 //    //     .style('fill', d3.scale.category20());  //function(d){return d.Deaths}
		 //    .data(data).enter()
		 //    .insert('rect')
		 //        .attr("class", "area").attr("clip-path", "url(#clip)")
		 //        .attr('x', function(d){x=x+prev+pad; prev=parseInt(d.All); return x;})
		 //        // .attr('x', function(d){return xScale(d.x)})
		 //        .attr('width', function(d){if(d.All==0) return 1; return (d.All)})
		 //        .attr('height', function(d){if(d.All==0) return 1; return (d.All)} )
		 //        .style('fill', d3.scale.category20());  //function(d){return d.Deaths}



			// g.selectAll("circle")
			// .data(data).enter()
		 //    .insert('circle')
		 //    	.attr("class", "area").attr("clip-path", "url(#clip)")
		 //        .attr('r', function(d){if(d.All==0) return 1; return xScale(d.All)})
		 //        .attr('cx', function(d){cx=cx+cprev+pad; cprev=parseInt(d.All); return cx;})
		 //    	.attr('cy', 200)
		 //    	.style('fill', "red");

		     update = function(){
			    g.selectAll("rect")
			        .transition().duration(500)
					.attr("x", function(d){return lx+parseInt(d.rX)-10});

			    g.selectAll("#l1")
			        .transition().duration(500)
			        .attr("x1", function(d){return lx+parseInt(d.inx1)})
		    		.attr("x2", function(d){return lx+parseInt(d.inx2)})

			    g.selectAll("#l2")
			        .transition().duration(500)
			        .attr("x1", function(d){return lx+parseInt(d.outx1)})
		    		.attr("x2", function(d){return lx+parseInt(d.outx2)})

		    	g.selectAll("#cAll")
			        .transition().duration(500)
			        .attr("cx", function(d){return lx+parseInt(d.rX)+40});

			    g.selectAll("#cDeaths")
			        .transition().duration(500)
			        .attr("cx", function(d){return lx+parseInt(d.rX)+40});

			    g.selectAll("text")
			        .transition().duration(500)
			        .attr("x", function(d){return lx+parseInt(d.rX)});

			    g.selectAll("#gender1")
			        .transition().duration(500)
			        .attr("x", function(d){return lx+parseInt(d.rX)})

			    g.selectAll("#gender2")
			        .transition().duration(500)
			        .attr("x", function(d){
			        	m=parseInt(d.Male);
			    		f=parseInt(d.Female);
			    		if((m+f)>0){
			    			t = m/(m+f)*80;
			    		}else t=0;

			    		return lx+t+parseInt(d.rX);
			    	});

			     g.selectAll("#day")
			        .transition().duration(500)
			        .attr("x", function(d){return lx+parseInt(d.rX)})

			    g.selectAll("#night")
			        .transition().duration(500)
			        .attr("x", function(d){
				        m=parseInt(d.Day);
			    		f=parseInt(d.Night);
			    		if((m+f)>0){
			    			t = m/(m+f)*80;
			    		}else t=0;

			    		return lx+t+parseInt(d.rX);
		    		});

			    g.selectAll("#figures")
			        .transition().duration(500)
			        // .attr("x", function(d){return lx+parseInt(d.rX)+30+d.All/2})
			        // .attr("x", function(d){return lx+parseInt(d.rX)+parseInt(d.All)+10})
			        .attr("x", function(d){return lx+parseInt(d.rX)+60})
		    	

			    g.selectAll("#figuresdeaths")
			        .transition().duration(500)
		    		// .attr("x", function(d){return lx+parseInt(d.rX)+d.All/2+30})
		    		.attr("x", function(d){return lx+parseInt(d.rX)+70})

			    // g.selectAll("circle")
			    //     .transition().duration(500)
			    //     // .attr('x', function(d){return xScale(d.x)});
			    //     .attr('cx', function(d){cx=cx+cprev+pad; cprev=parseInt(d.All); return cx;});
			};		
	});
	}
	
	var year=2014;

	

	function updateData(n){
		console.log(n)
		
		var d1;
		if(n==0){
			year=document.getElementById('years');
			d1=year[year.selectedIndex].value;
		}
		if(n==1){
			year=document.getElementById('years2');
			d1=year[year.selectedIndex].value;
		}
		else{
			d1 = n;
		}
		year=d1;
		var snippet = document.getElementById('snippet')
		snippet.innerHTML = year;
		// Effect.Shake('snippet')
		datasource = "data/"+d1+"Trains.csv";
		
		Effect.DropOut('finalmenu');
		// Effect.DropOut('selyears');

		var whichPage = page;
		console.log("?"+whichPage);

		// lx=0;
		// lx=-page*1100+1100;
		// lx = lx+speed*page;
		// page=1;

		if(n==0)
			run=false;
		else
			run=false;
		if(run)
			drawTheSvg();
		else
		{
			d3.csv([datasource], function(error, data){
				svg = d3.select('#chart');		


			g = svg.select("g");

			

			    g.selectAll("#l1")
			.data(data).enter();
			g.selectAll("#l1")
				.transition().duration(500)
				.attr("x1", function(d){return lx+parseInt(d.inx1)})
		    	.attr("y1", function(d){return d.iny1})
		    	.attr("x2", function(d){return lx+parseInt(d.inx2)})
		    	.attr("y2", function(d){return d.iny2})
		    	.attr("stroke",function(d){if(d.Line=="CR") return "lightblue"; else return "pink";})
		    	.attr("fill", "none")
		    	.attr("stroke-width", "6")
		    	.attr("stroke-opacity","0.7");
	    	 //   	.attr("x1", function(d){return lx+parseInt(d.inx1)})
		    	// .attr("y1", function(d){return d.iny1})
		    	// .attr("x2", function(d){return lx+parseInt(d.inx2)})
		    	// .attr("y2", function(d){return d.iny2})
		    	// .attr("stroke",function(d){if(d.Line=="CR") return "lightblue"; else return "pink";})
		    	// .attr("fill", "none")
		    	// .attr("stroke-width", "6")
		    	// .attr("stroke-opacity","0.7")
		    	// .style("stroke-dasharray", ("2,4,2,4,2,4"));


			g.selectAll("#stationsrect")
			.data(data).enter();
			g.selectAll("#stationsrect")
				.transition().duration(500)
				.attr("width","100")
		    	.attr("height", "20")
		    	.attr("rx", 6)
				.attr("ry", 6)
		    	.attr("x", function(d){ return lx+parseInt(d.rX)-10})
				.attr("y", function(d){return parseInt(d.rY)})
				.attr("fill", function(d){
					if(d.Type=="Interchange") return "#8AB66D";
					if(d.Type=="Slow") return "#99A6B0";
					if(d.Type=="Fast") return "#BC5C3D";
				})
				
		  //   	.attr("width","100")
		  //   	.attr("height", "20")
		  //   	.attr("rx", 6)
				// .attr("ry", 6)
		  //   	.attr("x", function(d){ return lx+parseInt(d.rX)-10})
				// .attr("y", function(d){return parseInt(d.rY)})
				// .attr("fill", function(d){
				// 	if(d.Type=="Interchange") return "#8AB66D";
				// 	if(d.Type=="Slow") return "#99A6B0";
				// 	if(d.Type=="Fast") return "#BC5C3D"
				// })
		  //   ;

		    g.selectAll("#l2")
			.data(data).enter();
		    g.selectAll("#l2")
		    	.attr("x1", function(d){return lx+parseInt(d.outx1)})
		    	.attr("y1", function(d){return d.outy1})
		    	.attr("x2", function(d){return lx+parseInt(d.outx2)})
		    	.attr("y2", function(d){return d.outy2})
		    	.attr("stroke",function(d){
		    		return "lightgrey";
		    		// if(d.Line=="CR") return "lightblue"; else return "pink";
		    	})
		    	.attr("fill", "none")
		    	.attr("stroke-width", "6")
		    	.attr("stroke-opacity","0.7")
		    	// .style("stroke-dasharray", ("2,4,2,4,2,4"))
		    ;
		    

		    g.selectAll("#cAll")
			.data(data).enter();
			g.selectAll("#cAll")
		        .transition().duration(500)
		    	.attr("cx", function(d){
		    		return lx+parseInt(d.rX)+40;
		    	})
		    	.attr("cy", function(d){
		    		if(d.Line == "CR")
		    			return parseInt(d.rY)-d.All/2-40-10;
		    		else
		    			return parseInt(d.rY)+d.All/2+40+20;
		    	})	
		    	// .attr("r", function(d){
		    	// 	if(d.All==0) return 1; 
		    	// 	return d.All/2;
		    	// })
		    	.attr("r", function(d){
		    		if(d.All==0) 
		    			return 1; 
		    		else
		    			return d.All/2;
		    	})
		    	.attr("fill", "#FFCC00")
		    	.attr("fill-opacity","0.6")
		    ;
		    	
		    	
			    	
			    	

		    g.selectAll("#cDeaths")
			.data(data).enter();
		    g.selectAll("#cDeaths")
		        .transition().duration(500)
		    	.attr("cx", function(d){return lx+parseInt(d.rX)+40})
		    	
		    	.attr("cy", function(d){
		    		if(d.Line == "CR")
		    			return parseInt(d.rY)-d.Deaths/2-40-10;
		    		else
		    			return parseInt(d.rY)+d.Deaths/2+40+20;
		    	})
		    	.attr("r", function(d){if(d.All==0) return 1; return d.Deaths/2})
		    	.attr("fill", "darkred")
		    	.attr("fill-opacity","0.8")
		    ;
		
			g.selectAll("#gender1")
			.data(data).enter();
			g.selectAll("#gender1")
		        .transition().duration(500)
		    	.attr("width", function(d){
		    		m=parseInt(d.Male);
		    		f=parseInt(d.Female);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// console.log("M:"+t)
		    		return t;
		    	})
		    	.attr("height", 10 )
		    	.attr("x", function(d){return lx+parseInt(d.rX);})
				.attr("y", function(d){if(d.Line=="CR")
		    			return parseInt(d.rY)-35;
		    		else
		    			return parseInt(d.rY)+35;
		    	})
				.attr("fill", "#31A2FD")
		    ;

		    g.selectAll("#gender2")
			.data(data).enter();
		    g.selectAll("#gender2")
		        .transition().duration(500)
		    	.attr("width", function(d){
		    		m=parseInt(d.Male);
		    		f=parseInt(d.Female);
		    		if((m+f)>0){
		    			t = f/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// t2=10-t
		    		// console.log("F:"+t)
		    		return t;
		    	})
		    	.attr("height", 10 )
		    	.attr("x", function(d){
		    		m=parseInt(d.Male);
		    		f=parseInt(d.Female);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;

		    		return lx+t+parseInt(d.rX);
		    	})
				.attr("y", function(d){if(d.Line=="CR")
		    			return parseInt(d.rY)-35;
		    		else
		    			return parseInt(d.rY)+35;
		    	})
				.attr("fill", "#491B65")
		    ;

		    g.selectAll("#day")
			.data(data).enter();
		    g.selectAll("#day")
		        .transition().duration(500)
		    	.attr("width", function(d){
		    		m=parseInt(d.Day);
		    		f=parseInt(d.Night);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// t2=10-t
		    		// console.log("F:"+t)
		    		return t;
		    	})
		    	.attr("height", 10 )
		    	.attr("x", function(d){return lx+parseInt(d.rX);})
				.attr("y", function(d){if(d.Line=="CR")
		    			return parseInt(d.rY)-20;
		    		else
		    			return parseInt(d.rY)+20;
		    	})
				.attr("fill", "#CC9900")
		    ;

		    g.selectAll("#night")
			.data(data).enter();
		    g.selectAll("#night")
		        .transition().duration(500)
		    	.attr("width", function(d){
		    		m=parseInt(d.Day);
		    		f=parseInt(d.Night);
		    		if((m+f)>0){
		    			t = f/(m+f)*80;
		    		}else t=0;
		    		t = Math.round(t);
		    		// t2=10-t
		    		// console.log("F:"+t)
		    		return t;
		    	})
		    	.attr("height", 10 )
		    	.attr("x", function(d){
		    		m=parseInt(d.Day);
		    		f=parseInt(d.Night);
		    		if((m+f)>0){
		    			t = m/(m+f)*80;
		    		}else t=0;

		    		return lx+t+parseInt(d.rX);
		    	})
				.attr("y", function(d){if(d.Line=="CR")
		    			return parseInt(d.rY)-20;
		    		else
		    			return parseInt(d.rY)+20;
		    	})
				.attr("fill", "#AEAEAE")
		    ;

		    g.selectAll("#stations")
			.data(data).enter();
			g.selectAll("#stations")
		        .transition().duration(500)
				.attr("class", "area").attr("clip-path", "url(#clip)")
		    	.attr("id", "stations")
		    	.attr("x", function(d){return lx+parseInt(d.rX)})
		    	.attr("y", function(d){return parseInt(d.rY)+15})
		    	.text(function (d) {return d.Station;})
		    	.attr("font-family", "sans-serif")
	            .attr("font-size", "11px")
	            .attr("fill", "white");
		    	;

		    g.selectAll("#figures")
			.data(data).enter();
		   	g.selectAll("#figures")
		        .transition().duration(500)
		        .attr("x", function(d){return lx+parseInt(d.rX)+60})
		    	// .attr("x", function(d){return lx+parseInt(d.rX)+30+d.All/2})
		    	// .attr("y", function(d){return lx+parseInt(d.rY)-d.All/2-25})
		    	// .attr("y", function(d){return lx+parseInt(d.rY)-d.All/2-25})
		    	.attr("y", function(d){
		    		if(d.Line=="CR")
		    			return parseInt(d.rY)-75;
	    			else
		    			return parseInt(d.rY)+105;
		    	})
		    	.text(function (d) {
		    		if(d.All==0)
		    			return "No incidents"
		    		else
		    			return d.All;
		    	})
		    	.attr("font-family", "Open Sans")
		    	.attr("font-weight", "Bold")
	            .attr("font-size", function (d) {
	            	if(d.All==0)
		    			return 10;
		    		else
		    	     	return 35;
	            })
	            .attr("fill", "grey")
	            .style("fill-opacity", "0.7")
	        ;

	        g.selectAll("#figuresdeaths")
			.data(data).enter();
		   	g.selectAll("#figuresdeaths")
		        .transition().duration(500)
		    	// .attr("x", function(d){return lx+parseInt(d.rX)+d.All/2+30})
		    	// .attr("y", function(d){return lx+parseInt(d.rY)-25})
		    	.attr("x", function(d){return lx+parseInt(d.rX)+70})
		    	.attr("y", function(d){
		    		if(d.Line=="CR")
		    			return parseInt(d.rY)-55;
	    			else
		    			return parseInt(d.rY)+75;
		    	})
		    	.text(function (d) {
		    		if(d.Deaths==0) 
		    			return "";
		    		else 
		    			return d.Deaths;
		    	})
		    	.attr("font-family", "Open Sans")
		    	.attr("font-weight", "light")
	            .attr("font-size", function (d) {
	            	// var size=Math.round(d.All/3);
	            	// if(size<9) size=9;
	            	// return size;
	            	return 16;
	            })
	            .attr("fill", "grey")
	            .style("fill-opacity", "0.7")
		    	;


			});
			// console.log("updated")
			// for(i=0; i<whichPage; i++){
			// 	console.log ("moved")
			// 	moveRight();
			// }
		}

		// update();
	}


	var page=1;

	function moveLeft(){
		Effect.Appear('snippet', {duration: 0.8} );
		
		// Effect.Fade('popme');
		// popped = false;	
		
		page = (page-1);
		if(page<1) page=1;
		console.log(page);
		if(page==1){
			console.log(page);
			Effect.Appear('selyears');
		}
		if(page==pages-1)
			Effect.DropOut('finalmenu');

		if(x>=0) {
	    		l=0;
	    		lx=0;
	    		cx=0;
	    		showLogo();
	    		Effect.Shake('chart',{duration:0.1, distance:5}); 
	    		return;
	    	}
    	hideLogo();
    	l=l+speed;
		x=l;
		lx = lx+speed;
		cx=l;
		// console.log("L:"+x);
		if(x>=0) {
    		l=0;
    		lx=0;
    		cx=0;
    		showLogo();
	    }
		update();
	}

	function moveRight(){
			Effect.Appear('snippet', {duration: 0.8} );

			// Effect.Fade('popme');
			// popped = false;	

			page = (page+1);
			if(page>=pages)
				page = pages;
			if(page==pages)
				Effect.Appear('finalmenu');
			console.log(page);

			if(page>1){
				Effect.DropOut('selyears');
			}

			if(x<=-(pages-1)*speed) {
				Effect.Shake('chart',{duration:0.1, distance:5}); 
				
				return;}

	       	hideLogo();
	       	l=l-speed;
			x=l;
			lx = lx-speed;

			if(x<=-pages*speed) {x=-pages*speed; l=-pages*speed;}

			cx=l;
			if(cx<=-pages*speed) {x=-pages*speed; l=-pages*speed;}

			// console.log("R:"+x)
		    update();
	}

	var checkKey = function(e){
		// console.log(e);
	    if (e.keyCode == '38') {
	        // up arrow
	    }
	    else if (e.keyCode == '40') {
	        // down arrow
	    }
	    else if (e.keyCode == '37') {
	    	// left arrow
	    	// console.log("L:"+x)
	    	moveLeft()
	    }
	    else if (e.keyCode == '39') {
	       	// right arrow
	       	// console.log("R:"+x)
	       moveRight();
	    }



	}


//http://bl.ocks.org/mbostock/c501f6cae402ab5e90c9
	

	var width = 500,
	    height = 300,
	    radius = height / 2 - 10;

	var arc = d3.svg.arc()
	    .innerRadius(radius - 20)
	    .outerRadius(radius)
	    .cornerRadius(20);

	var pie = d3.layout.pie()
	    .padAngle(.02);

	var color = d3.scale.category10();

	var svg = d3.select('#chart2').append('svg')
	// var svg = d3.select("body").append("svg")
	    .attr("width", width)
	    .attr("height", height)
	  .append("g")
	    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

	svg.selectAll("path")
	    .data(pie(gender))
	  .enter().append("path")
	    .style("fill", function(d, i) { return color(i); })
	    .attr("d", arc);

	updatePie = function(){
		console.log(gender[0] + "," +gender[1])
		svg.selectAll("path")
			.data(pie(gender))
			// .enter().append("path")
		    .style("fill", function(d, i) { return color(i); })
		    .attr("d", arc)
		    .transition().duration(1000);
	}

	</script>


<div id="chart2" style="display:none"></div>
<div id="popme" style="position: absolute; top:300px; left:200px; border:1px solid red; color: red; background-color: #100000; padding:5px; display: none;background-image: url(images/bg.jpg)" onClick="hidePopup()">
<span id="stationName"></span></div>

<div id="snippet" style="position: absolute; top:590px; left:400px; padding:5px; display: block; color: gold; font-weight:bold; font-size:25px">2014</div>

<div id="selyears" style="position: absolute; top:450px; left:300px;">
 <select id="years" onchange="updateData('0')">
	<option value="2014">2014</option>
	<option value="2013">2013</option>
	<option value="2012">2012</option>
</select>
</div>

<div id="finalmenu" style="position: absolute; top:250px; left:900px; display: none">
 <a href="#">View full map</a>
 <br/><br/>
 Take a journey again for year 
 <select id="years2" onchange="updateData('1'); skipToStart(); ">
	<option value="2014">2014</option>
	<option value="2013">2013</option>
	<option value="2012">2012</option>
</select>
<br/><br/>
<a href="indexWeek.html?d=month&sd=day">home.html</a>
</div>

<div id="startskip" style="position: absolute; top:610px; left:80px; font-size:x-small">
	<a href="#" onclick="skipToStart()">back to start</a> | <a href="#" onclick="skip()">skip to end</a>
 ||| <a href="#" onclick="updateData('2014')">2014</a>
 | <a href="#" onclick="updateData('2013')">2013</a>
 | <a href="#" onclick="updateData('2012')">2012</a>

</div>


<script>
	var calendar = new CalHeatMap();
	var itemNameV = "incident";
	var verticalOrientationV = false;
	var startDates = [2012, 2013, 2014];
	var domainV = "month";
	var domainDynamicDimensionV = false;
	var domainGutterV = 2;
	var domainMarginV = 2;
	var subDomainV = "day";
	var domainLabelFormatV = "%b-%y"; 
	//subDomainTextFormat: "%d",
	var rangeV = 12;
	var leg = [0,1,2,4];
	// var leg = [80,120,150,170];
	var legendVerticalPositionV = "center";
	var legendOrientationV = "vertical";
	var cellSizeV = 9;
	var dataV = "jsons/ThaneAll.json";
	var inited=false;
	function showCalendar(){
		if(!inited){
			calendar.init({
			itemSelector: "#popme",
			itemName: itemNameV,
			verticalOrientation: verticalOrientationV,
	    	data: dataV,
	    	start: new Date(2014, 0),
	    	domain: domainV,
			domainLabelFormat: domainLabelFormatV,
			domainDynamicDimension: domainDynamicDimensionV,
			domainGutter: domainGutterV,
		    domainMargin: domainMarginV,
	    	subDomain: subDomainV,
	    	considerMissingDataAsZero: true,
	    	//rowLimit: 31,
			//subDomainTextFormat: "%d",
			// subDomainTitleFormat: {
			// 	filled:	"Whats is going on {name} to be {count} if {date} over {connector}",
			// 	empty: "nothing to declare on {date}"
			// },
			range: rangeV,
			legend: leg,
			legendVerticalPosition: legendVerticalPositionV,
			legendOrientation: legendOrientationV,
			//legendMargin: [0,20,0,0],
			cellSize: cellSizeV,
			// legendColors: {
			// 	empty: "green"
			// }
			});
			inited=true;
		}else{
			calendar.update(dataV);
		}
	
	}
	    

</script>
</body>
<html>